#!/bin/bash

# tm: a simple task manager
#
# Inspired on lftm by Coraline (https://github.com/CoralineAda/lftm)


function create_directory () {
    # Create directory (and its parents) if needed
    if [[ ! -d "$1" ]]; then
        mkdir -p "$1"
    fi
}


function main () {
    # Define some date variables
    year=$(date '+%Y')
    year_month=$(date '+%Y-%m')
    month_year=$(date '+%B, %Y')
    today_weekday=$(date '+%Y-%m-%d %A')

    # Define directory name for the current tasks
    dirname="$journal_dir"/$year

    # Define file name for current tasks
    tasksfile="$dirname"/$year_month.md

    # Create directory for current tasks
    create_directory "$dirname"

    # cd to journal_dir
    cd "$journal_dir" || exit

    # Check if current tasks file exists and get last date
    if [[ -f "$tasksfile" ]]; then
        # Get last date in the file
        #   regex finds every line that matches a today_weekday
        #   tail gets the last one of those lines
        last_date=$(grep -E "^[0-9]{4}-[0-9]{2}-[0-9]{2} \w+$" "$tasksfile" | tail -n 1 )
    else
        # Create notes_file if missing
        echo "Tasks for $month_year" > "$tasksfile"
        for (( i == 0; i < 9 + $(echo "$month_year" | wc -c); ++i));
            do echo -n "=" >> "$tasksfile";
        done
        last_date=""
    fi

    # Start editing the notes file with Neovim
    if [[ $last_date == "$today_weekday" ]]; then
        $editor -c "norm G" -c "norm zz" "$tasksfile"
    else
        $editor -c "norm Go" \
            -c "norm Go$today_weekday" \
            -c "norm yyp" \
            -c "norm GVr-" \
            -c "norm zz" \
            -c "norm Go" \
            "$tasksfile"
    fi
}

# Define global variables for storing the notes and choosing text editor
journal_dir=$HOME/documents/notes/tasks
editor=nvim  # choose either vim, nvim or equivalent

# Run main function
main
